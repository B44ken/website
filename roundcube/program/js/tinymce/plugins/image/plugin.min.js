!function(l){"use strict";function n(t,e){return function(t,e){for(var n=null!=e?e:b,r=0;r<t.length&&null!=n;++r)n=n[t[r]];return n}(t.split("."),e)}var t=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=function(t){return!1!==t.settings.image_dimensions},i=function(t){return!0===t.settings.image_advtab},c=function(t){return t.getParam("image_prepend_url","")},e=function(t){return t.getParam("image_class_list")},r=function(t){return!1!==t.settings.image_description},o=function(t){return!0===t.settings.image_title},s=function(t){return!0===t.settings.image_caption},a=function(t){return t.getParam("image_list",!1)},d=function(t){return t.getParam("images_upload_url",!1)},m=function(t){return t.getParam("images_upload_handler",!1)},g=function(t){return t.getParam("images_upload_url")},f=function(t){return t.getParam("images_upload_handler")},p=function(t){return t.getParam("images_upload_base_path")},h=function(t){return t.getParam("images_upload_credentials")},b=void 0!==l.window?l.window:Function("return this;")(),v={getOrDie:function(t,e){e=n(t,e);if(null==e)throw new Error(t+" not available on this browser");return e}};function y(t,e){return Math.max(parseInt(t,10),parseInt(e,10))}function x(t){return t.style.marginLeft&&t.style.marginRight&&t.style.marginLeft===t.style.marginRight?lt(t.style.marginLeft):""}function w(t){return t.style.marginTop&&t.style.marginBottom&&t.style.marginTop===t.style.marginBottom?lt(t.style.marginTop):""}function C(t){return t.style.borderWidth?lt(t.style.borderWidth):""}function N(t,e){return t.hasAttribute(e)?t.getAttribute(e):""}function S(t,e){return t.style[e]||""}function _(t){return null!==t.parentNode&&"FIGURE"===t.parentNode.nodeName}function T(t,e,n){t.setAttribute(e,n)}function A(t){var e,n;_(t)?(n=(e=t).parentNode,ht.insertAfter(e,n),ht.remove(n)):(n=t,t=ht.create("figure",{class:"image"}),ht.insertAfter(t,n),t.appendChild(n),t.appendChild(ht.create("figcaption",{contentEditable:!0},"Caption")),t.contentEditable="false")}function R(t,e){var n=t.getAttribute("style");0<(n=e(null!==n?n:"")).length?(t.setAttribute("style",n),t.setAttribute("data-mce-style",n)):t.removeAttribute("style")}function I(t,r){return function(t,e,n){t.style[e]?(t.style[e]=ut(n),R(t,r)):T(t,e,n)}}function O(t,e){return t.style[e]?lt(t.style[e]):N(t,e)}function L(t,e){e=ut(e),t.style.marginLeft=e,t.style.marginRight=e}function P(t,e){e=ut(e),t.style.marginTop=e,t.style.marginBottom=e}function U(t,e){e=ut(e),t.style.borderWidth=e}function E(t,e){t.style.borderStyle=e}function k(t){return"FIGURE"===t.nodeName}function M(){return{src:"",alt:"",title:"",width:"",height:"",class:"",style:"",caption:!1,hspace:"",vspace:"",border:"",borderStyle:""}}function D(t,e){var n=l.document.createElement("img");return T(n,"style",e.style),!x(n)&&""===e.hspace||L(n,e.hspace),!w(n)&&""===e.vspace||P(n,e.vspace),!C(n)&&""===e.border||U(n,e.border),!S(n,"borderStyle")&&""===e.borderStyle||E(n,e.borderStyle),t(n.getAttribute("style"))}function z(t,e){return{src:N(e,"src"),alt:N(e,"alt"),title:N(e,"title"),width:O(e,"width"),height:O(e,"height"),class:N(e,"class"),style:t(N(e,"style")),caption:_(e),hspace:x(e),vspace:w(e),border:C(e),borderStyle:S(e,"borderStyle")}}function B(t,e,n,r,o){n[r]!==e[r]&&o(t,r,n[r])}function H(r,o){return function(t,e,n){r(t,n),R(t,o)}}function j(t,e){return e=t.dom.styles.parse(e),e=ct(e),e=t.dom.styles.parse(t.dom.styles.serialize(e)),t.dom.styles.serialize(e)}function F(t){var e=t.selection.getNode(),n=t.dom.getParent(e,"figure.image");return n?t.dom.select("img",n)[0]:e&&("IMG"!==e.nodeName||e.getAttribute("data-mce-object")||e.getAttribute("data-mce-placeholder"))?null:e}function W(e,t){var n=e.dom,r=n.getParent(t.parentNode,function(t){return e.schema.getTextBlockElements()[t.nodeName]},e.getBody());return r?n.split(r,t):t}function J(e){var t=F(e);return t?z(function(t){return j(e,t)},t):M()}function V(e,t){var n=function(t,e){var n=l.document.createElement("img");if(bt(t,pt(e,{caption:!1}),n),T(n,"alt",e.alt),e.caption){e=ht.create("figure",{class:"image"});return e.appendChild(n),e.appendChild(ht.create("figcaption",{contentEditable:!0},"Caption")),e.contentEditable="false",e}return n}(function(t){return j(e,t)},t);e.dom.setAttrib(n,"data-mce-id","__mcenew"),e.focus(),e.selection.setContent(n.outerHTML),t=e.dom.select('*[data-mce-id="__mcenew"]')[0],e.dom.setAttrib(t,"data-mce-id",null),k(t)?(n=W(e,t),e.selection.select(n)):e.selection.select(t)}function G(t,e){var n,r,o,i,a;(a=F(t))?e.src?(r=e,i=F(n=t),bt(function(t){return j(n,t)},r,i),o=i,n.dom.setAttrib(o,"src",o.getAttribute("src")),k(i.parentNode)?(o=i.parentNode,W(n,o),n.selection.select(i.parentNode)):(n.selection.select(i),dt(n,r,i))):(i=t,(a=a)&&(a=i.dom.is(a.parentNode,"figure.image")?a.parentNode:a,i.dom.remove(a),i.focus(),i.nodeChanged(),i.dom.isEmpty(i.getBody())&&(i.setContent(""),i.selection.setCursorLocation()))):e.src&&V(t,e)}function $(n,r){r.find("#style").each(function(t){var e=D(function(t){return j(n,t)},pt(M(),r.toJSON()));t.value(e)})}function X(t,e){t.state.set("oldVal",t.value()),e.state.set("oldVal",e.value())}function q(t,e){var n=t.find("#width")[0],r=t.find("#height")[0],t=t.find("#constrain")[0];n&&r&&t&&e(n,r,t.checked())}function K(t,e,n){var r=t.state.get("oldVal"),o=e.state.get("oldVal"),i=t.value(),a=e.value();n&&r&&o&&i&&a&&(i!==r?(a=Math.round(i/r*a),isNaN(a)||e.value(a)):(i=Math.round(a/o*i),isNaN(i)||t.value(i))),X(t,e)}function Q(t){q(t,K)}function Y(t){t.meta=t.control.rootControl.toJSON()}function Z(a,t){return t=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(t){var e,n,r,o,i;n=a,r=(e=t).meta||{},o=e.control,i=o.rootControl,(t=i.find("#image-list")[0])&&t.value(n.convertURL(o.value(),"src")),rt.each(r,function(t,e){i.find("#"+e).value(t)}),r.width||r.height||(e=n.convertURL(o.value(),"src"),t=c(n),r=new RegExp("^(?:[a-z]+:)?//","i"),t&&!r.test(e)&&e.substring(0,t.length)!==t&&(e=t+e),o.value(e),it(n.documentBaseURI.toAbsolute(o.value()),function(t){t.width&&t.height&&u(n)&&(i.find("#width").value(t.width),i.find("#height").value(t.height),xt(i))}))},onbeforecall:Y},t],r(a)&&t.push({name:"alt",type:"textbox",label:"Image description"}),o(a)&&t.push({name:"title",type:"textbox",label:"Image Title"}),u(a)&&t.push(yt()),e(a)&&t.push({name:"class",type:"listbox",label:"Class",values:at(e(a),function(t){t.value&&(t.textStyle=function(){return a.formatter.getCssText({inline:"img",classes:[t.value]})})})}),s(a)&&t.push({name:"caption",type:"checkbox",label:"Caption"}),t}function tt(){return v.getOrDie("URL")}var et,nt=tinymce.util.Tools.resolve("tinymce.util.Promise"),rt=tinymce.util.Tools.resolve("tinymce.util.Tools"),ot=tinymce.util.Tools.resolve("tinymce.util.XHR"),it=function(t,n){var r=l.document.createElement("img");function e(t,e){r.parentNode&&r.parentNode.removeChild(r),n({width:t,height:e})}r.onload=function(){e(y(r.width,r.clientWidth),y(r.height,r.clientHeight))},r.onerror=function(){e(0,0)};var o=r.style;o.visibility="hidden",o.position="fixed",o.bottom=o.left="0px",o.width=o.height="auto",l.document.body.appendChild(r),r.src=t},at=function(t,o,e){return function n(t,r){return r=r||[],rt.each(t,function(t){var e={text:t.text||t.title};t.menu?e.menu=n(t.menu):(e.value=t.value,o(e)),r.push(e)}),r}(t,e||[])},lt=function(t){return t=t&&t.replace(/px$/,"")},ut=function(t){return 0<t.length&&/^[0-9]+$/.test(t)&&(t+="px"),t},ct=function(t){if(t.margin){var e=t.margin.split(" ");switch(e.length){case 1:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[0],t["margin-bottom"]=t["margin-bottom"]||e[0],t["margin-left"]=t["margin-left"]||e[0];break;case 2:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[0],t["margin-left"]=t["margin-left"]||e[1];break;case 3:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[2],t["margin-left"]=t["margin-left"]||e[1];break;case 4:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[2],t["margin-left"]=t["margin-left"]||e[3]}delete t.margin}return t},st=function(t,e){t=a(t);"string"==typeof t?ot.send({url:t,success:function(t){e(JSON.parse(t))}}):"function"==typeof t?t(e):e(t)},dt=function(t,e,n){function r(){n.onload=n.onerror=null,t.selection&&(t.selection.select(n),t.nodeChanged())}n.onload=function(){e.width||e.height||!u(t)||t.dom.setAttribs(n,{width:n.clientWidth,height:n.clientHeight}),r()},n.onerror=r},mt=function(r){return new nt(function(t,e){var n=new(v.getOrDie("FileReader"));n.onload=function(){t(n.result)},n.onerror=function(){e(n.error.message)},n.readAsDataURL(r)})},gt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),ft=Object.prototype.hasOwnProperty,pt=(et=function(t,e){return e},function(){for(var t=new Array(arguments.length),e=0;e<t.length;e++)t[e]=arguments[e];if(0===t.length)throw new Error("Can't merge zero objects");for(var n={},r=0;r<t.length;r++){var o,i=t[r];for(o in i)ft.call(i,o)&&(n[o]=et(n[o],i[o]))}return n}),ht=gt.DOM,bt=function(t,e,n){var r=z(t,n);B(n,r,e,"caption",function(t,e,n){return A(t),0}),B(n,r,e,"src",T),B(n,r,e,"alt",T),B(n,r,e,"title",T),B(n,r,e,"width",I(0,t)),B(n,r,e,"height",I(0,t)),B(n,r,e,"class",T),B(n,r,e,"style",H(function(t,e){return T(t,"style",e),0},t)),B(n,r,e,"hspace",H(L,t)),B(n,r,e,"vspace",H(P,t)),B(n,r,e,"border",H(U,t)),B(n,r,e,"borderStyle",H(E,t))},vt=function(e){return{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:(r=e,function(t){var e=r.dom,n=t.control.rootControl;i(r)&&(t=n.toJSON(),t=e.parseStyle(t.style),n.find("#vspace").value(""),n.find("#hspace").value(""),((t=ct(t))["margin-top"]&&t["margin-bottom"]||t["margin-right"]&&t["margin-left"])&&(t["margin-top"]===t["margin-bottom"]?n.find("#vspace").value(lt(t["margin-top"])):n.find("#vspace").value(""),t["margin-right"]===t["margin-left"]?n.find("#hspace").value(lt(t["margin-right"])):n.find("#hspace").value("")),t["border-width"]?n.find("#border").value(lt(t["border-width"])):n.find("#border").value(""),t["border-style"]?n.find("#borderStyle").value(t["border-style"]):n.find("#borderStyle").value(""),n.find("#style").value(e.serializeStyle(e.parseStyle(e.serializeStyle(t)))))})},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,defaults:{type:"textbox",maxWidth:50,onchange:function(t){$(e,t.control.rootControl)}},items:[{label:"Vertical space",name:"vspace"},{label:"Border width",name:"border"},{label:"Horizontal space",name:"hspace"},{label:"Border style",type:"listbox",name:"borderStyle",width:90,maxWidth:90,onselect:function(t){$(e,t.control.rootControl)},values:[{text:"Select...",value:""},{text:"Solid",value:"solid"},{text:"Dotted",value:"dotted"},{text:"Dashed",value:"dashed"},{text:"Double",value:"double"},{text:"Groove",value:"groove"},{text:"Ridge",value:"ridge"},{text:"Inset",value:"inset"},{text:"Outset",value:"outset"},{text:"None",value:"none"},{text:"Hidden",value:"hidden"}]}]}]};var r},yt=function(){function t(t){Q(t.control.rootControl)}return{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:5,onchange:t,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:5,onchange:t,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}},xt=function(t){q(t,X)},wt=Q,Ct=function(t,e){return{title:"General",type:"form",items:Z(t,e)}},Nt=Z,St=function(t){return tt().createObjectURL(t)},_t=function(t){tt().revokeObjectURL(t)},Tt=tinymce.util.Tools.resolve("tinymce.ui.Factory");function At(){}function Rt(a){function e(t,n,r,e){var o,i=new(v.getOrDie("XMLHttpRequest"));i.open("POST",a.url),i.withCredentials=a.credentials,i.upload.onprogress=function(t){e(t.loaded/t.total*100)},i.onerror=function(){r("Image upload failed due to a XHR Transport error. Code: "+i.status)},i.onload=function(){var t,e;i.status<200||300<=i.status?r("HTTP Error: "+i.status):(e=JSON.parse(i.responseText))&&"string"==typeof e.location?n((t=a.basePath,e=e.location,t?t.replace(/\/$/,"")+"/"+e.replace(/^\//,""):e)):r("Invalid JSON: "+i.responseText)},(o=new l.FormData).append("file",t.blob(),t.filename()),i.send(o)}return a=rt.extend({credentials:!1,handler:e},a),{upload:function(t){return a.url||a.handler!==e?(n=t,r=a.handler,new nt(function(t,e){try{r(n,t,e,At)}catch(t){e(t.message)}})):nt.reject("Upload url missing from the settings.");var n,r}}}function It(u){return function(t){function n(){o.hide(),_t(a)}var e=Tt.get("Throbber"),r=t.control.rootControl,o=new e(r.getEl()),i=t.control.value(),a=St(i),l=Rt({url:g(u),basePath:p(u),credentials:h(u),handler:f(u)});return o.show(),mt(i).then(function(t){t=u.editorUpload.blobCache.create({blob:i,blobUri:a,name:i.name?i.name.replace(/\.[^\.]+$/,""):null,base64:t.split(",")[1]});return l.upload(t).then(function(t){var e=r.find("#src");return e.value(t),r.find("tabpanel")[0].activateTab(0),e.fire("change"),n(),t})}).catch(function(t){u.windowManager.alert(t),n()})}}var Ot=".jpg,.jpeg,.png,.gif",Lt=function(t){return{title:"Upload",type:"form",layout:"flex",direction:"column",align:"stretch",padding:"20 20 20 20",items:[{type:"container",layout:"flex",direction:"column",align:"center",spacing:10,items:[{text:"Browse for an image",type:"browsebutton",accept:Ot,onchange:It(t)},{text:"OR",type:"label"}]},{text:"Drop an image here",type:"dropzone",accept:Ot,height:100,onchange:It(t)}]}};function Pt(r){for(var o=[],t=1;t<arguments.length;t++)o[t-1]=arguments[t];return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=o.concat(t);return r.apply(null,n)}}function Ut(e,t){var n=t.control.getRoot();wt(n),e.undoManager.transact(function(){var t=pt(J(e),n.toJSON());G(e,t)}),e.editorUpload.uploadImagesAuto()}function Et(o){function t(t){var n,e,r=J(o);t&&(e={type:"listbox",label:"Image list",name:"image-list",values:at(t,function(t){t.value=o.convertURL(t.value||t.url,"src")},[{text:"None",value:""}]),value:r.src&&o.convertURL(r.src,"src"),onselect:function(t){var e=n.find("#alt");(!e.value()||t.lastControl&&e.value()===t.lastControl.text())&&e.value(t.control.text()),n.find("#src").value(t.control.value()).fire("change")},onPostRender:function(){e=this}}),n=i(o)||d(o)||m(o)?(t=[Ct(o,e)],i(o)&&t.push(vt(o)),(d(o)||m(o))&&t.push(Lt(o)),o.windowManager.open({title:"Insert/edit image",data:r,bodyType:"tabpanel",body:t,onSubmit:Pt(Ut,o)})):o.windowManager.open({title:"Insert/edit image",data:r,body:Nt(o,e),onSubmit:Pt(Ut,o)}),xt(n)}return{open:function(){st(o,t)}}}function kt(o){return function(t){for(var e,n=t.length,r=function(t){t.attr("contenteditable",o?"true":null)};n--;)(function(t){t=t.attr("class");return t&&/\bimage\b/.test(t)})(e=t[n])&&(e.attr("contenteditable",o?"false":null),rt.each(e.getAll("figcaption"),r))}}var Mt=function(t){t.addCommand("mceImage",Et(t).open)},Dt=function(t){t.on("preInit",function(){t.parser.addNodeFilter("figure",kt(!0)),t.serializer.addNodeFilter("figure",kt(!1))})},zt=function(t){t.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:Et(t).open,stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),t.addMenuItem("image",{icon:"image",text:"Image",onclick:Et(t).open,context:"insert",prependToContext:!0})};t.add("image",function(t){Dt(t),zt(t),Mt(t)})}(window);