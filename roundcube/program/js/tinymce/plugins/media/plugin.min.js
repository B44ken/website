!function(){"use strict";function o(e){return function(){return e}}var e=tinymce.util.Tools.resolve("tinymce.PluginManager"),a=tinymce.util.Tools.resolve("tinymce.Env"),u=tinymce.util.Tools.resolve("tinymce.util.Tools"),s=function(e){return e.getParam("media_scripts")},l=function(e){return e.getParam("audio_template_callback")},m=function(e){return e.getParam("video_template_callback")},c=function(e){return e.getParam("media_live_embeds",!0)},t=function(e){return e.getParam("media_filter_html",!0)},d=function(e){return e.getParam("media_url_resolver")},h=function(e){return e.getParam("media_alt_source",!0)},f=function(e){return e.getParam("media_poster",!0)},p=function(e){return e.getParam("media_dimensions",!0)},r=function(e){var t=e,e=function(){return t};return{get:e,set:function(e){t=e},clone:function(){return r(t)}}},g=o(!1),v=o(!0),i=function(){return w},w=(W={fold:function(e,t){return e()},is:g,isSome:g,isNone:v,getOr:b,getOrThunk:n,getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:o(null),getOrUndefined:o(void 0),or:b,orThunk:n,map:i,each:function(){},bind:i,exists:g,forall:v,filter:i,equals:W=function(e){return e.isNone()},equals_:W,toArray:function(){return[]},toString:o("none()")},Object.freeze&&Object.freeze(W),W);function n(e){return e()}function b(e){return e}function y(e,t){return U(e,t)?J(e[t]):E()}function x(e){return e.replace(/px$/,"")}function O(e){return/^[0-9.]+$/.test(e)?e+"px":e}function j(e,t){for(var r in t){var i=""+t[r];if(e.map[r])for(var n=e.length;n--;){var o=e[n];o.name===r&&(i?(e.map[r]=i,o.value=i):(delete e.map[r],e.splice(n,1)))}else i&&(e.push({name:r,value:i}),e.map[r]=i)}}function _(e,t){for(var r=e.regex.exec(t),i=e.url,n=0;n<r.length;n++)!function(e){i=i.replace("$"+e,function(){return r[e]||""})}(n);return i.replace(/\?$/,"")}function S(i,n,o){return new B(function(t,e){function r(e){return e.html&&(te[i.source1]=e),t({url:i.source1,html:e.html||n(i)})}te[i.source1]?r(te[i.source1]):o({url:i.source1},r,e)})}function k(t){return function(e){return ee(t,e)}}function N(e,t){e.state.set("oldVal",e.value()),t.state.set("oldVal",t.value())}function M(e,t){var r=e.find("#width")[0],i=e.find("#height")[0],e=e.find("#constrain")[0];r&&i&&e&&t(r,i,e.checked())}function T(e,t,r){var i=e.state.get("oldVal"),n=t.state.get("oldVal"),o=e.value(),a=t.value();r&&i&&n&&o&&a&&(o!==i?(a=Math.round(o/i*a),isNaN(a)||t.value(a)):(o=Math.round(a/n*o),isNaN(o)||e.value(o))),N(e,t)}function z(e){M(e,T)}function A(t){return function(e){e=e&&e.msg?"Media embed handler error: "+e.msg:"Media embed handler threw unknown error.";t.notificationManager.open({type:"error",text:e})}}function C(i,n){return function(e){var t=e.html,r=i.find("#embed")[0],e=u.extend(V(s(n),t),{source1:e.url});i.fromJSON(e),r&&(r.value(t),ce(i))}}function $(e,t){var r=e.dom.select("img[data-mce-object]");e.insertContent(t),function(e,t){for(var r,i=e.dom.select("img[data-mce-object]"),n=0;n<t.length;n++)for(r=i.length-1;0<=r;r--)t[n]===i[r]&&i.splice(r,1);e.selection.select(i[0])}(e,r),e.nodeChanged()}function P(e,t){var r=t.name,i=new de("img",1);return i.shortEnded=!0,fe(e,t,i),i.attr({width:t.attr("width")||"300",height:t.attr("height")||("audio"===r?"30":"150"),style:t.attr("style"),src:a.transparentSrc,"data-mce-object":r,class:"mce-object mce-object-"+r}),i}function F(e,t){var r=t.name,i=new de("span",1);return i.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":r,class:"mce-preview-object mce-object-"+r}),fe(e,t,i),(r=new de(r,1)).attr({src:t.attr("src"),allowfullscreen:t.attr("allowfullscreen"),style:t.attr("style"),class:t.attr("class"),width:t.attr("width"),height:t.attr("height"),frameborder:"0"}),(t=new de("span",1)).attr("class","mce-shim"),i.append(r),i.append(t),i}function D(e){for(;e=e.parent;)if(e.attr("data-ephox-embed-iri"))return 1}var L=function(r){function e(){return n}function t(e){return e(r)}var i=o(r),n={fold:function(e,t){return t(r)},is:function(e){return r===e},isSome:v,isNone:g,getOr:i,getOrThunk:i,getOrDie:i,getOrNull:i,getOrUndefined:i,or:e,orThunk:e,map:function(e){return L(e(r))},each:function(e){e(r)},bind:t,exists:t,forall:t,filter:function(e){return e(r)?n:w},toArray:function(){return[r]},toString:function(){return"some("+r+")"},equals:function(e){return e.is(r)},equals_:function(e,t){return e.fold(g,function(e){return t(r,e)})}};return n},E=i,J=function(e){return null==e?w:L(e)},R=Object.hasOwnProperty,U=function(e,t){return R.call(e,t)},W=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),H=tinymce.util.Tools.resolve("tinymce.html.SaxParser"),I=function(e,t){if(e)for(var r=0;r<e.length;r++)if(-1!==t.indexOf(e[r].filter))return e[r]},q=W.DOM,V=function(n,e){var o=r(!1),a={};return H({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(e,t){if(!o.get())if(U(t.map,"data-ephox-embed-iri"))o.set(!0),i=(i=(r=t).map.style)?q.parseStyle(i):{},a={type:"ephox-embed-iri",source1:r.map["data-ephox-embed-iri"],source2:"",poster:"",width:y(i,"max-width").map(x).getOr(""),height:y(i,"max-height").map(x).getOr("")};else{if(a.source1||"param"!==e||(a.source1=t.map.movie),"iframe"!==e&&"object"!==e&&"embed"!==e&&"video"!==e&&"audio"!==e||(a.type||(a.type=e),a=u.extend(t.map,a)),"script"===e){i=I(n,t.map.src);if(!i)return;a={type:"script",source1:t.map.src,width:i.width,height:i.height}}"source"===e&&(a.source1?a.source2||(a.source2=t.map.src):a.source1=t.map.src),"img"!==e||a.poster||(a.poster=t.map.src)}var r,i}}).parse(e),a.source1=a.source1||a.src||a.data,a.source2=a.source2||"",a.poster=a.poster||"",a},B=tinymce.util.Tools.resolve("tinymce.util.Promise"),G=function(e){e={mp3:"audio/mpeg",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",swf:"application/x-shockwave-flash"}[e.toLowerCase().split(".").pop()];return e||""},K=tinymce.util.Tools.resolve("tinymce.html.Schema"),Q=tinymce.util.Tools.resolve("tinymce.html.Writer"),X=W.DOM,Y=function(e,a,c){var u,s=Q(),l=r(!1),m=0;return H({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(e){s.comment(e)},cdata:function(e){s.cdata(e)},text:function(e,t){s.text(e,t)},start:function(e,t,r){if(!l.get())if(U(t.map,"data-ephox-embed-iri"))l.set(!0),i=a,(o=(o=(n=t).map.style)?X.parseStyle(o):{})["max-width"]=O(i.width),o["max-height"]=O(i.height),j(n,{style:X.serializeStyle(o)});else{switch(e){case"video":case"object":case"embed":case"img":case"iframe":void 0!==a.height&&void 0!==a.width&&j(t,{width:a.width,height:a.height})}if(c)switch(e){case"video":j(t,{poster:a.poster,src:""}),a.source2&&j(t,{src:""});break;case"iframe":j(t,{src:a.source1});break;case"source":if(m++,m<=2&&(j(t,{src:a["source"+m],type:a["source"+m+"mime"]}),!a["source"+m]))return;break;case"img":if(!a.poster)return;u=!0}}var i,n,o;s.start(e,t,r)},end:function(e){if(!l.get()){if("video"===e&&c)for(var t,r=1;r<=2;r++)a["source"+r]&&((t=[]).map={},m<r&&(j(t,{src:a["source"+r],type:a["source"+r+"mime"]}),s.start("source",t,!0)));var i;a.poster&&"object"===e&&c&&!u&&((i=[]).map={},j(i,{src:a.poster,width:a.width,height:a.height}),s.start("img",i,!0))}s.end(e)}},K({})).parse(e),s.getContent()},Z=[{regex:/youtu\.be\/([\w\-_\?&=.]+)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)(&([a-z0-9&=\-_]+))?/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2?$4",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\?&=\-_]+)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowFullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowFullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0},{regex:/dai\.ly\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],ee=function(r,e){var i=u.extend({},e);if(!i.source1&&(u.extend(i,V(s(r),i.embed)),!i.source1))return"";i.source2||(i.source2=""),i.poster||(i.poster=""),i.source1=r.convertURL(i.source1,"source"),i.source2=r.convertURL(i.source2,"source"),i.source1mime=G(i.source1),i.source2mime=G(i.source2),i.poster=r.convertURL(i.poster,"poster");var t,e=(t=i.source1,0<(n=Z.filter(function(e){return e.regex.test(t)})).length?u.extend({},n[0],{url:_(n[0],t)}):null);if(e&&(i.source1=e.url,i.type=e.type,i.allowFullscreen=e.allowFullscreen,i.width=i.width||e.w,i.height=i.height||e.h),i.embed)return Y(i.embed,i,!0);var n=I(s(r),i.source1);n&&(i.type="script",i.width=n.width,i.height=n.height);var o,a,c,e=l(r),n=m(r);return i.width=i.width||300,i.height=i.height||150,u.each(i,function(e,t){i[t]=r.dom.encode(e)}),"iframe"===i.type?(c=(a=i).allowFullscreen?' allowFullscreen="1"':"",'<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"'+c+"></iframe>"):"application/x-shockwave-flash"===i.source1mime?(c='<object data="'+(a=i).source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(c+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),c+="</object>"):-1!==i.source1mime.indexOf("audio")?(o=i,(e=e)?e(o):'<audio controls="controls" src="'+o.source1+'">'+(o.source2?'\n<source src="'+o.source2+'"'+(o.source2mime?' type="'+o.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"===i.type?'<script src="'+i.source1+'"><\/script>':(o=i,(n=n)?n(o):'<video width="'+o.width+'" height="'+o.height+'"'+(o.poster?' poster="'+o.poster+'"':"")+' controls="controls">\n<source src="'+o.source1+'"'+(o.source1mime?' type="'+o.source1mime+'"':"")+" />\n"+(o.source2?'<source src="'+o.source2+'"'+(o.source2mime?' type="'+o.source2mime+'"':"")+" />\n":"")+"</video>")},te={},re=function(e,t){var r,i,n=d(e);return n?S(t,k(e),n):(r=t,i=k(e),new B(function(e){e({html:i(r),url:r.source1})}))},ie=function(e){return te.hasOwnProperty(e)},ne={getMaxWidth:(i=function(t){return function(e){return e?e.style[t].replace(/px$/,""):""}})("maxWidth"),getMaxHeight:i("maxHeight"),setMaxWidth:(W=function(r){return function(e,t){e&&(e.style[r]=/^[0-9.]+$/.test(t=t)?t+"px":t)}})("maxWidth"),setMaxHeight:W("maxHeight")},oe=function(e){function t(){e(function(e){z(e)})}return{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:5,onchange:t,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:5,onchange:t,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}},ae=function(e){M(e,N)},ce=z,ue=a.ie&&a.ie<=8?"onChange":"onInput",se=function(i){var n,e,t,r=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onpaste:function(){setTimeout(function(){re(i,n.toJSON()).then(C(n,i)).catch(A(i))},1)},onchange:function(e){var r;re(i,n.toJSON()).then(C(n,i)).catch(A(i)),r=n,e=e.meta,u.each(e,function(e,t){r.find("#"+t).value(e)})},onbeforecall:function(e){e.meta=n.toJSON()}}],o=[];h(i)&&o.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),f(i)&&o.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),p(i)&&(t=oe(function(e){e(n),a=n.toJSON(),n.find("#embed").value(Y(a.embed,a))}),r.push(t)),c=(e=i).selection.getNode();var a=(t=c.getAttribute("data-ephox-embed-iri"))?{source1:t,"data-ephox-embed-iri":t,width:ne.getMaxWidth(c),height:ne.getMaxHeight(c)}:c.getAttribute("data-mce-object")?V(s(e),e.serializer.serialize(c,{selection:!0})):{},c={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:function(e){var t=e.selection.getNode();if(t.getAttribute("data-mce-object")||t.getAttribute("data-ephox-embed-iri"))return e.selection.getContent()}(i),multiline:!0,rows:5,label:"Source"};c[ue]=function(){a=u.extend({},V(s(i),this.value())),this.parent().parent().fromJSON(a)};c=[{title:"General",type:"form",items:r},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},c]}];0<o.length&&c.push({title:"Advanced",type:"form",items:o}),n=i.windowManager.open({title:"Insert/edit media",data:a,bodyType:"tabpanel",body:c,onSubmit:function(){var e,t;ce(n),t=i,(e=(e=n).toJSON()).embed=Y(e.embed,e),e.embed&&ie(e.source1)?$(t,e.embed):re(t,e).then(function(e){$(t,e.html)}).catch(A(t))}}),ae(n)},le=function(e){return{showDialog:function(){se(e)}}},me=function(e){e.addCommand("mceMedia",function(){se(e)})},de=tinymce.util.Tools.resolve("tinymce.html.Node"),he=function(o,e){if(!1===t(o))return e;var a,c=Q();return H({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(e){c.comment(e)},cdata:function(e){c.cdata(e)},text:function(e,t){c.text(e,t)},start:function(e,t,r){if(a=!0,"script"!==e&&"noscript"!==e&&"svg"!==e){for(var i=t.length-1;0<=i;i--){var n=t[i].name;0===n.indexOf("on")&&(delete t.map[n],t.splice(i,1)),"style"===n&&(t[i].value=o.dom.serializeStyle(o.dom.parseStyle(t[i].value),e))}c.start(e,t,r),a=!1}},end:function(e){a||c.end(e)}},K({})).parse(e),c.getContent()},fe=function(e,t,r){for(var i,n,o=t.attributes,a=o.length;a--;)i=o[a].name,n=o[a].value,"width"!==i&&"height"!==i&&"style"!==i&&("data"!==i&&"src"!==i||(n=e.convertURL(n,i)),r.attr("data-mce-p-"+i,n));(t=t.firstChild&&t.firstChild.value)&&(r.attr("data-mce-html",escape(he(e,t))),r.firstChild=null)},pe=function(n){return function(e){for(var t,r,i=e.length;i--;)(t=e[i]).parent&&(t.parent.attr("data-mce-object")||"script"===t.name&&!(r=I(s(n),t.attr("src")))||(r&&(r.width&&t.attr("width",r.width.toString()),r.height&&t.attr("height",r.height.toString())),"iframe"===t.name&&c(n)&&a.ceFalse?D(t)||t.replace(F(n,t)):D(t)||t.replace(P(n,t))))}},ge=function(l){l.on("preInit",function(){var t=l.schema.getSpecialElements();u.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});var r=l.schema.getBoolAttrs();u.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){r[e]={}}),l.parser.addNodeFilter("iframe,video,audio,object,embed,script",pe(l)),l.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var r,i,n,o,a,c,u=e.length;u--;)if((r=e[u]).parent){for(a=r.attr(t),i=new de(a,1),"audio"!==a&&"script"!==a&&((c=r.attr("class"))&&-1!==c.indexOf("mce-preview-object")?i.attr({width:r.firstChild.attr("width"),height:r.firstChild.attr("height")}):i.attr({width:r.attr("width"),height:r.attr("height")})),i.attr({style:r.attr("style")}),n=(o=r.attributes).length;n--;){var s=o[n].name;0===s.indexOf("data-mce-p-")&&i.attr(s.substr(11),o[n].value)}"script"===a&&i.attr("type","text/javascript"),(c=r.attr("data-mce-html"))&&((a=new de("#text",3)).raw=!0,a.value=he(l,unescape(c)),i.append(a)),r.replace(i)}})}),l.on("setContent",function(){l.$("span.mce-preview-object").each(function(e,t){var r=l.$(t);0===r.find("span.mce-shim",t).length&&r.append('<span class="mce-shim"></span>')})})},ve=function(e){e.on("ResolveName",function(e){var t;1===e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)})},we=function(t){t.on("click keyup",function(){var e=t.selection.getNode();e&&t.dom.hasClass(e,"mce-preview-object")&&t.dom.getAttrib(e,"data-mce-selected")&&e.setAttribute("data-mce-selected","2")}),t.on("ObjectSelected",function(e){var t=e.target.getAttribute("data-mce-object");"audio"!==t&&"script"!==t||e.preventDefault()}),t.on("objectResized",function(e){var t,r=e.target;r.getAttribute("data-mce-object")&&(t=r.getAttribute("data-mce-html"))&&(t=unescape(t),r.setAttribute("data-mce-html",escape(Y(t,{width:e.width,height:e.height}))))})},be=function(e){e.addButton("media",{tooltip:"Insert/edit media",cmd:"mceMedia",stateSelector:["img[data-mce-object]","span[data-mce-object]","div[data-ephox-embed-iri]"]}),e.addMenuItem("media",{icon:"media",text:"Media",cmd:"mceMedia",context:"insert",prependToContext:!0})};e.add("media",function(e){return me(e),be(e),ve(e),ge(e),we(e),le(e)})}();