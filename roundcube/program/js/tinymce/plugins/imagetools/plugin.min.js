!function(d){"use strict";function t(){}var r=function(t){var e=t,t=function(){return e};return{get:t,set:function(t){e=t},clone:function(){return r(e)}}},e=tinymce.util.Tools.resolve("tinymce.PluginManager"),J=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return function(){return t}};function a(r){for(var o=[],t=1;t<arguments.length;t++)o[t-1]=arguments[t];return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=o.concat(t);return r.apply(null,n)}}var n,c=i(!1),u=i(!0),o=function(){return l},l=(n=function(t){return t.isNone()},n={fold:function(t,e){return t()},is:c,isSome:c,isNone:u,getOr:f,getOrThunk:s,getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:i(null),getOrUndefined:i(void 0),or:f,orThunk:s,map:o,each:t,bind:o,exists:c,forall:u,filter:o,equals:n,equals_:n,toArray:function(){return[]},toString:i("none()")},Object.freeze&&Object.freeze(n),n);function s(t){return t()}function f(t){return t}var h=function(n){function t(){return o}function e(t){return t(n)}var r=i(n),o={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:u,isNone:c,getOr:r,getOrThunk:r,getOrDie:r,getOrNull:r,getOrUndefined:r,or:t,orThunk:t,map:function(t){return h(t(n))},each:function(t){t(n)},bind:e,exists:e,forall:e,filter:function(t){return t(n)?o:l},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(c,function(t){return e(n,t)})}};return o},p={some:h,none:o,from:function(t){return null==t?l:h(t)}};function m(t,e){return y(d.document.createElement("canvas"),t,e)}function g(t){var e=m(t.width,t.height);return v(e).drawImage(t,0,0),e}function v(t){return t.getContext("2d")}function y(t,e,n){return t.width=e,t.height=n,t}function w(t){return t.naturalWidth||t.width}function b(t){return t.naturalHeight||t.height}var x,k,R=window.Promise||(x=I.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(t){d.setTimeout(t,1)},k=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},I.prototype.catch=function(t){return this.then(null,t)},I.prototype.then=function(n,r){var o=this;return new I(function(t,e){T.call(o,new E(n,r,t,e))})},I.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var c=Array.prototype.slice.call(1===t.length&&k(t[0])?t[0]:t);return new I(function(o,i){if(0===c.length)return o([]);var a=c.length;for(var t=0;t<c.length;t++)!function e(n,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if("function"==typeof r)return void r.call(t,function(t){e(n,t)},i)}c[n]=t,0==--a&&o(c)}catch(t){i(t)}}(t,c[t])})},I.resolve=function(e){return e&&"object"==typeof e&&e.constructor===I?e:new I(function(t){t(e)})},I.reject=function(n){return new I(function(t,e){e(n)})},I.race=function(o){return new I(function(t,e){for(var n=0,r=o;n<r.length;n++)r[n].then(t,e)})},I);function I(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],O(t,M(U,this),M(C,this))}function M(t,e){return function(){return t.apply(e,arguments)}}function T(n){var r=this;null!==this._state?x(function(){var t,e=r._state?n.onFulfilled:n.onRejected;if(null!==e){try{t=e(r._value)}catch(t){return void n.reject(t)}n.resolve(t)}else(r._state?n.resolve:n.reject)(r._value)}):this._deferreds.push(n)}function U(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void O(M(e,t),M(U,this),M(C,this))}this._state=!0,this._value=t,A.call(this)}catch(t){C.call(this,t)}}function C(t){this._state=!1,this._value=t,A.call(this)}function A(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];T.call(this,n)}this._deferreds=[]}function E(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function O(t,e,n){var r=!1;try{t(function(t){r||(r=!0,e(t))},function(t){r||(r=!0,n(t))})}catch(t){if(r)return;r=!0,n(t)}}function _(t){var r,t=t.src;return 0===t.indexOf("data:")?z(t):(r=t,new R(function(t,n){var e=new d.XMLHttpRequest;e.open("GET",r,!0),e.responseType="blob",e.onload=function(){200===this.status&&t(this.response)},e.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},e.send()}))}function j(c){return new R(function(t,e){var n=d.URL.createObjectURL(c),r=new d.Image,o=function(){r.removeEventListener("load",i),r.removeEventListener("error",a)};function i(){o(),t(r)}function a(){o(),e("Unable to load data of type "+c.type+": "+n)}r.addEventListener("load",i),r.addEventListener("error",a),r.src=n,r.complete&&i()})}function z(n){return new R(function(t,e){!function(t){var e=t.split(",");if(!(t=/data:([^;]+)/.exec(e[0])))return p.none();for(var t=t[1],e=e[1],n=d.atob(e),r=n.length,o=Math.ceil(r/1024),i=new Array(o),a=0;a<o;++a){for(var c=1024*a,u=Math.min(1024+c,r),l=new Array(u-c),s=c,f=0;s<u;++f,++s)l[f]=n[s].charCodeAt(0);i[a]=new Uint8Array(l)}return p.some(new d.Blob(i,{type:t}))}(n).fold(function(){e("uri is not base64: "+n)},t)})}function L(t,r,o){return r=r||"image/png",d.HTMLCanvasElement.prototype.toBlob?new R(function(e,n){t.toBlob(function(t){t?e(t):n()},r,o)}):z(t.toDataURL(r,o))}function B(t){return j(t).then(function(t){e=t,d.URL.revokeObjectURL(e.src);var e=m(w(t),b(t));return v(e).drawImage(t,0,0),e})}var S=j,H=_;function P(t,e,n){var r=e.type;function o(r,o){return t.then(function(t){return n=o,e=(e=r)||"image/png",t.toDataURL(e,n);var e,n})}return{getType:i(r),toBlob:function(){return R.resolve(e)},toDataURL:function(){return n},toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return L(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(g)}}}function D(e){return n=e,new R(function(t){var e=new d.FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n)}).then(function(t){return P(B(e),e,t)});var n}function F(e,t){return L(e,t).then(function(t){return P(R.resolve(e),t,e.toDataURL())})}function V(t,e,n){t="string"==typeof t?parseFloat(t):t;return n<t?t=n:t<e&&(t=e),t}function W(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]}var N=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10];function q(t,e){for(var n=[],r=new Array(25),o=0;o<5;o++){for(var i=0;i<5;i++)n[i]=e[i+5*o];for(i=0;i<5;i++){for(var a=0,c=0;c<5;c++)a+=t[i+5*c]*n[c];r[i+5*o]=a}}return r}function $(t,n){return n=V(n,0,1),t.map(function(t,e){return e%6==0?t=1-(1-t)*n:t*=n,V(t,0,1)})}function X(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var r=v(t);n=function(t,e){for(var n,r,o,i,a=t.data,c=e[0],u=e[1],l=e[2],s=e[3],f=e[4],d=e[5],h=e[6],p=e[7],m=e[8],g=e[9],v=e[10],y=e[11],w=e[12],b=e[13],x=e[14],k=e[15],R=e[16],I=e[17],M=e[18],T=e[19],U=0;U<a.length;U+=4)n=a[U],r=a[U+1],o=a[U+2],i=a[U+3],a[U]=n*c+r*u+o*l+i*s+f,a[U+1]=n*d+r*h+o*p+i*m+g,a[U+2]=n*v+r*y+o*w+i*b+x,a[U+3]=n*k+r*R+o*I+i*M+T;return t}(r.getImageData(0,0,t.width,t.height),n);return r.putImageData(n,0,0),F(t,e)}(t,e.getType(),n)})}function Y(a,c){return a.toCanvas().then(function(t){return e=t,n=a.getType(),r=c,o=v(e),i=o.getImageData(0,0,e.width,e.height),t=o.getImageData(0,0,e.width,e.height),t=function(t,e,n){function r(t,e,n){return n<t?t=n:t<e&&(t=e),t}for(var o=Math.round(Math.sqrt(n.length)),i=Math.floor(o/2),a=t.data,c=e.data,u=t.width,l=t.height,s=0;s<l;s++)for(var f=0;f<u;f++){for(var d=0,h=0,p=0,m=0;m<o;m++)for(var g=0;g<o;g++){var v=r(f+g-i,0,u-1),y=4*(r(s+m-i,0,l-1)*u+v),v=n[m*o+g];d+=a[y]*v,h+=a[1+y]*v,p+=a[2+y]*v}var w=4*(s*u+f);c[w]=r(d,0,255),c[1+w]=r(h,0,255),c[2+w]=r(p,0,255)}return e}(i,t,r),o.putImageData(t,0,0),F(e,n);var e,n,r,o,i})}function G(c){function r(t,e,n){for(var r=v(t),o=new Array(256),i=0;i<o.length;i++)o[i]=c(i,n);var a=function(t,e){for(var n=t.data,r=0;r<n.length;r+=4)n[r]=e[n[r]],n[r+1]=e[n[r+1]],n[r+2]=e[n[r+2]];return t}(r.getImageData(0,0,t.width,t.height),o);return r.putImageData(a,0,0),F(t,e)}return function(e,n){return e.toCanvas().then(function(t){return r(t,e.getType(),n)})}}function K(n){return function(t,e){return X(t,n(W(),e))}}function Z(e){return function(t){return Y(t,e)}}var Q,tt=(Q=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0,0,0,0,0,1],function(t){return X(t,Q)}),et=K(function(t,e){return q(t,[1,0,0,0,e=V(255*e,-255,255),0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}),nt=K(function(t,e){e=V(e,-180,180)/180*Math.PI;var n=Math.cos(e),r=Math.sin(e),o=.213,i=.715;return q(t,[o+.787*n+r*-o,i+n*-i+r*-i,(e=.072)+n*-e+.928*r,0,0,o+n*-o+.143*r,i+n*(1-i)+.14*r,e+n*-e+-.283*r,0,0,o+n*-o+-.787*r,i+n*-i+r*i,e+.928*n+r*e,0,0,0,0,0,1,0,0,0,0,0,1])}),rt=K(function(t,e){return e=1+(0<(e=V(e,-1,1))?3*e:e),q(t,[.3086*(1-e)+e,.6094*(1-e),.082*(1-e),0,0,.3086*(1-e),.6094*(1-e)+e,.082*(1-e),0,0,.3086*(1-e),.6094*(1-e),.082*(1-e)+e,0,0,0,0,0,1,0,0,0,0,0,1])}),ot=K(function(t,e){var n;return e=V(e,-1,1),q(t,[(n=(e*=100)<0?127+e/100*127:127*(n=0===(n=e%1)?N[e]:N[Math.floor(e)]*(1-n)+N[Math.floor(e)+1]*n)+127)/127,0,0,0,.5*(127-n),0,n/127,0,0,.5*(127-n),0,0,n/127,0,.5*(127-n),0,0,0,1,0,0,0,0,0,1])}),it=K(function(t,e){return q(t,$([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],e=V(e,0,1)))}),at=K(function(t,e){return q(t,$([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],e=V(e,0,1)))}),ct=Z([0,-1,0,-1,5,-1,0,-1,0]),ut=Z([-2,-1,0,-1,1,1,0,1,2]),lt=G(function(t,e){return 255*Math.pow(t/255,1-e)}),st=G(function(t,e){return 255*(1-Math.exp(-t/255*e))});function ft(t,e,n){var r=w(t),o=b(t),i=e/r,r=n/o,o=!1;(i<.5||2<i)&&(i=i<.5?.5:2,o=!0),(r<.5||2<r)&&(r=r<.5?.5:2,o=!0);var a,c,u,r=(a=t,c=i,u=r,new R(function(t){var e=w(a),n=b(a),r=Math.floor(e*c),o=Math.floor(n*u),i=m(r,o);v(i).drawImage(a,0,0,e,n,0,0,r,o),t(i)}));return o?r.then(function(t){return ft(t,e,n)}):r}function dt(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var r=m(t.width,t.height),o=v(r),i=0,a=0;90!==(n=n<0?360+n:n)&&270!==n||y(r,r.height,r.width);90!==n&&180!==n||(i=r.width);270!==n&&180!==n||(a=r.height);return o.translate(i,a),o.rotate(n*Math.PI/180),o.drawImage(t,0,0),F(r,e)}(t,e.getType(),n)})}function ht(e,n){return e.toCanvas().then(function(t){return function(t,e,n){var r=m(t.width,t.height),o=v(r);"v"===n?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0));return F(r,e)}(t,e.getType(),n)})}function pt(e,n,r,o,i){return e.toCanvas().then(function(t){return function(t,e,n,r,o,i){i=m(o,i);return v(i).drawImage(t,-n,-r),F(i,e)}(t,e.getType(),n,r,o,i)})}function mt(t,e){return function(t,e){for(var n=null!=e?e:zt,r=0;r<t.length&&null!=n;++r)n=n[t[r]];return n}(t.split("."),e)}function gt(){return Lt("URL")}var vt=function(t){return tt(t)},yt=function(t){return ct(t)},wt=function(t){return ut(t)},bt=function(t,e){return lt(t,e)},xt=function(t,e){return st(t,e)},kt=function(t,e,n,r){return X(t,(t=W(),n=n,r=r,q(t,[V(e,0,2),0,0,0,0,0,n=V(n,0,2),0,0,0,0,0,r=V(r,0,2),0,0,0,0,0,1,0,0,0,0,0,1])))},Rt=function(t,e){return et(t,e)},It=function(t,e){return nt(t,e)},Mt=function(t,e){return rt(t,e)},Tt=function(t,e){return ot(t,e)},Ut=function(t,e){return it(t,e)},Ct=function(t,e){return at(t,e)},At=ht,Et=pt,Ot=function(t,e,n){return o=e,i=n,(r=t).toCanvas().then(function(t){return ft(t,o,i).then(function(t){return F(t,r.getType())})});var r,o,i},_t=dt,jt=D,zt=void 0!==d.window?d.window:Function("return this;")(),Lt=function(t,e){e=mt(t,e);if(null==e)throw new Error(t+" not available on this browser");return e},Bt={createObjectURL:function(t){return gt().createObjectURL(t)},revokeObjectURL:function(t){gt().revokeObjectURL(t)}},St=tinymce.util.Tools.resolve("tinymce.util.Delay"),Ht=tinymce.util.Tools.resolve("tinymce.util.Promise"),Pt=tinymce.util.Tools.resolve("tinymce.util.URI"),Dt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),Ft=tinymce.util.Tools.resolve("tinymce.ui.Factory");function Vt(){var n=[],r=-1;function t(){return 0<r}function e(){return-1!==r&&r<n.length-1}return{data:n,add:function(t){var e=n.splice(++r);return n.push(t),{state:t,removed:e}},undo:function(){if(0<r)return n[--r]},redo:function(){if(e())return n[++r]},canUndo:t,canRedo:e}}var Wt=tinymce.util.Tools.resolve("tinymce.geom.Rect"),Nt=function(n){return new Ht(function(t){var e=function(){n.removeEventListener("load",e),t(n)};n.complete?t(n):n.addEventListener("load",e)})},qt=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),$t=tinymce.util.Tools.resolve("tinymce.util.Observable"),Xt=tinymce.util.Tools.resolve("tinymce.util.VK"),Yt=0;function Gt(c,n,u,r,o){var l,a,t,i,e="mce-",s=e+"crid-"+Yt++;function f(t,e){return{x:e.x-t.x,y:e.y-t.y,w:e.w,h:e.h}}function d(t,e,n,r){var o=e.x,i=e.y,a=e.w,e=e.h;o+=n*t.deltaX,i+=r*t.deltaY,(a+=n*t.deltaW)<20&&(a=20),(e+=r*t.deltaH)<20&&(e=20),t=c=Wt.clamp({x:o,y:i,w:a,h:e},u,"move"===t.name),t=f(u,t),l.fire("updateRect",{rect:t}),m(t)}function h(e){function t(t,e){e.h<0&&(e.h=0),e.w<0&&(e.w=0),qt("#"+s+"-"+t,r).css({left:e.x,top:e.y,width:e.w,height:e.h})}J.each(a,function(t){qt("#"+s+"-"+t.name,r).css({left:e.w*t.xMul+e.x,top:e.h*t.yMul+e.y})}),t("top",{x:n.x,y:n.y,w:n.w,h:e.y-n.y}),t("right",{x:e.x+e.w,y:e.y,w:n.w-e.x-e.w+n.x,h:e.h}),t("bottom",{x:n.x,y:e.y+e.h,w:n.w,h:n.h-e.y-e.h+n.y}),t("left",{x:n.x,y:e.y,w:e.x-n.x,h:e.h}),t("move",e)}function p(t){h(c=t)}function m(t){var e;p((e=u,{x:(t=t).x+e.x,y:t.y+e.y,w:t.w,h:t.h}))}return a=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],i=["top","right","bottom","left"],qt('<div id="'+s+'" class="'+e+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(r),J.each(i,function(t){qt("#"+s,r).append('<div id="'+s+"-"+t+'"class="'+e+'croprect-block" style="display: none" data-mce-bogus="all">')}),J.each(a,function(t){qt("#"+s,r).append('<div id="'+s+"-"+t.name+'" class="'+e+"croprect-handle "+e+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),t=J.map(a,function(e){var n;return new(Ft.get("DragHelper"))(s,{document:r.ownerDocument,handle:s+"-"+e.name,start:function(){n=c},drag:function(t){d(e,n,t.deltaX,t.deltaY)}})}),h(c),qt(r).on("focusin focusout",function(t){qt(t.target).attr("aria-grabbed","focus"===t.type)}),qt(r).on("keydown",function(e){var i;function t(t,e,n,r,o){t.stopPropagation(),t.preventDefault(),d(i,n,r,o)}switch(J.each(a,function(t){if(e.target.id===s+"-"+t.name)return i=t,!1}),e.keyCode){case Xt.LEFT:t(e,0,c,-10,0);break;case Xt.RIGHT:t(e,0,c,10,0);break;case Xt.UP:t(e,0,c,0,-10);break;case Xt.DOWN:t(e,0,c,0,10);break;case Xt.ENTER:case Xt.SPACEBAR:e.preventDefault(),o()}}),l=J.extend({toggleVisibility:function(t){var e=J.map(a,function(t){return"#"+s+"-"+t.name}).concat(J.map(i,function(t){return"#"+s+"-"+t})).join(",");t?qt(e,r).show():qt(e,r).hide()},setClampRect:function(t){u=t,h(c)},setRect:p,getInnerRect:function(){return f(u,c)},setInnerRect:m,setViewPortRect:function(t){n=t,h(c)},destroy:function(){J.each(t,function(t){t.destroy()}),t=[]}},$t)}var Kt={create:function(t){return new(Ft.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(t){var r=this,o=new d.Image;o.src=t,Nt(o).then(function(){var t,e=r.state.get("viewRect"),n=r.$el.find("img");n[0]?n.replaceWith(o):((t=d.document.createElement("div")).className="mce-imagepanel-bg",r.getEl().appendChild(t),r.getEl().appendChild(o)),t={x:0,y:0,w:o.naturalWidth,h:o.naturalHeight},r.state.set("viewRect",t),r.state.set("rect",Wt.inflate(t,-20,-20)),e&&e.w===t.w&&e.h===t.h||r.zoomFit(),r.repaintImage(),r.fire("load")})},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t=this.$el.find("img"),e=this.getEl().clientWidth,n=this.getEl().clientHeight,r=t[0].naturalWidth,t=t[0].naturalHeight,t=Math.min((e-10)/r,(n-10)/t);1<=t&&(t=1),this.zoom(t)},repaintImage:function(){var t=this.getEl(),e=this.zoom(),n=this.state.get("rect"),r=this.$el.find("img"),o=this.$el.find(".mce-imagepanel-bg"),i=t.offsetWidth,a=t.offsetHeight,c=r[0].naturalWidth*e,u=r[0].naturalHeight*e,l=Math.max(0,i/2-c/2),t=Math.max(0,a/2-u/2);r.css({left:l,top:t,width:c,height:u}),o.css({left:l,top:t,width:c,height:u}),this.cropRect&&(this.cropRect.setRect({x:n.x*e+l,y:n.y*e+t,w:n.w*e,h:n.h*e}),this.cropRect.setClampRect({x:l,y:t,w:c,h:u}),this.cropRect.setViewPortRect({x:0,y:0,w:i,h:a}))},bindStates:function(){var n=this;n.state.on("change:cropEnabled",function(t){n.cropRect.toggleVisibility(t.value),n.repaintImage()}),n.state.on("change:zoom",function(){n.repaintImage()}),n.state.on("change:rect",function(t){var e=t.value;n.cropRect||(t=e,n.cropRect=Gt(t,n.state.get("viewRect"),n.state.get("viewRect"),n.getEl(),function(){n.fire("crop")}),n.cropRect.on("updateRect",function(t){var e=t.rect,t=n.zoom(),e={x:Math.round(e.x/t),y:Math.round(e.y/t),w:Math.round(e.w/t),h:Math.round(e.h/t)};n.state.set("rect",e)}),n.on("remove",n.cropRect.destroy)),n.cropRect.setRect(e)})}}))(t)}};function Jt(t){return{blob:t,url:Bt.createObjectURL(t)}}function Zt(t){t&&Bt.revokeObjectURL(t.url)}function Qt(t){J.each(t,Zt)}function te(i,a,t,e){function c(t){return i.rtl?t.reverse():t}var u,n,r,l,o,s,f,d,h,p,m,g,v,y,w,b,x,k,R,I,M,T,U,C,A,E=Vt();function O(t){var e=u.find("#w")[0],n=u.find("#h")[0],r=parseInt(e.value(),10),o=parseInt(n.value(),10);u.find("#constrain")[0].checked()&&T&&U&&r&&o&&("w"===t.control.settings.name?(o=Math.round(r*C),n.value(o)):(r=Math.round(o*A),e.value(r))),T=r,U=o}function _(t){return Math.round(100*t)+"%"}function j(){u.find("#undo").disabled(!E.canUndo()),u.find("#redo").disabled(!E.canRedo()),u.statusbar.find("#save").disabled(!E.canUndo())}function z(){u.find("#undo").disabled(!0),u.find("#redo").disabled(!0)}function L(t){t&&d.imageSrc(t.url)}function B(e){return function(){var t=J.grep(M,function(t){return t.settings.name!==e});J.each(t,function(t){t.hide()}),e.show(),e.focus()}}function S(t){L(l=Jt(t))}function H(t){L(a=Jt(t)),Qt(E.add(a).removed),j()}function P(){var e=d.selection();jt(a.blob).then(function(t){Et(t,e.x,e.y,e.w,e.h).then(X).then(function(t){H(t),F()})})}var D=function(e){var n=[].slice.call(arguments,1);return function(){jt((l||a).blob).then(function(t){e.apply(this,[t].concat(n)).then(X).then(S)})}};function F(){L(a),Zt(l),B(n)(),j()}function V(){l?(H(l.blob),F()):function t(e,n){l?n():setTimeout(function(){0<e--?t(e,n):i.windowManager.alert("Error: failed to apply image operation.")},10)}(100,V)}function W(t){return Ft.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}var N,q,$,X=function(t){return t.toBlob()};function Y(t,e){return W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:V}])).hide().on("show",function(){z(),jt(a.blob).then(function(t){return e(t)}).then(X).then(function(t){t=Jt(t);L(t),Zt(l),l=t})})}function G(t,n,e,r,o){return W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){var e;e=t.value,jt(a.blob).then(function(t){return n(t,e)}).then(X).then(function(t){t=Jt(t);L(t),Zt(l),l=t})},minValue:i.rtl?o:r,maxValue:i.rtl?r:o,value:e,previewFilter:_},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:V}])).hide().on("show",function(){this.find("slider").value(e),z()})}function K(){var e=u.find("#r")[0].value(),n=u.find("#g")[0].value(),r=u.find("#b")[0].value();jt(a.blob).then(function(t){return N(t,e,n,r)}).then(X).then(function(t){t=Jt(t);L(t),Zt(l),l=t})}o=W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:P}])).hide().on("show hide",function(t){d.toggleCropRect("show"===t.type)}).on("show",z),s=W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:O},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:O},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(C=U/T,A=T/U)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(t){var e=parseInt(u.find("#w").value(),10),n=parseInt(u.find("#h").value(),10);t.preventDefault(),function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=[].slice.call(arguments,1);return function(){jt(a.blob).then(function(t){e.apply(this,[t].concat(r)).then(X).then(H)})}}(Ot,e,n)(),F()}).on("show",z),f=W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:D(At,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:D(At,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:D(_t,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:D(_t,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:V}])).hide().on("show",z),h=Y(0,vt),x=Y(0,yt),k=Y(0,wt),p=G(0,Rt,0,-1,1),m=G(0,It,180,0,360),g=G(0,Mt,0,-1,1),v=G(0,Tt,0,-1,1),y=G(0,Ut,0,0,1),w=G(0,Ct,0,0,1),N=kt,q=i.rtl?2:0,$=i.rtl?0:2,b=W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:q,value:1,maxValue:$,ondragend:K,previewFilter:_},{type:"slider",label:"G",name:"g",minValue:q,value:1,maxValue:$,ondragend:K,previewFilter:_},{type:"slider",label:"B",name:"b",minValue:q,value:1,maxValue:$,ondragend:K,previewFilter:_},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:V}])).hide().on("show",function(){u.find("#r,#g,#b").value(1),z()}),R=G(0,bt,0,-1,1),I=G(0,xt,1,0,2),r=W(c([{text:"Back",onclick:F},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:B(m)},{text:"saturate",icon:"saturate",onclick:B(g)},{text:"sepia",icon:"sepia",onclick:B(w)},{text:"emboss",icon:"emboss",onclick:B(k)},{text:"exposure",icon:"exposure",onclick:B(I)},{type:"spacer",flex:1}])).hide(),n=W(c([{tooltip:"Crop",icon:"crop",onclick:B(o)},{tooltip:"Resize",icon:"resize2",onclick:B(s)},{tooltip:"Orientation",icon:"orientation",onclick:B(f)},{tooltip:"Brightness",icon:"sun",onclick:B(p)},{tooltip:"Sharpen",icon:"sharpen",onclick:B(x)},{tooltip:"Contrast",icon:"contrast",onclick:B(v)},{tooltip:"Color levels",icon:"drop",onclick:B(b)},{tooltip:"Gamma",icon:"gamma",onclick:B(R)},{tooltip:"Invert",icon:"invert",onclick:B(h)}])),d=Kt.create({flex:1,imageSrc:a.url}),D=Ft.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){L(a=E.undo()),j()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){L(a=E.redo()),j()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=d.zoom();t<2&&(t+=.1),d.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=d.zoom();.1<t&&(t-=.1),d.zoom(t)}}]}),D=Ft.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:c([D,d])}),M=[n,o,s,f,r,h,p,m,g,v,y,w,b,x,k,R,I],(u=i.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(Dt.DOM.getViewPort().w,800),minHeight:Math.min(Dt.DOM.getViewPort().h,650),title:"Edit image",items:M.concat([D]),buttons:c([{text:"Save",name:"save",subtype:"primary",onclick:function(){t(a.blob),u.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){e(),Qt(E.data),l=E=null}),E.add(a),j(),d.on("load",function(){T=d.imageSize().w,U=d.imageSize().h,C=U/T,A=T/U,u.find("#w").value(T),u.find("#h").value(U)}),d.on("crop",P)}var ee={edit:function(r,t){return new Ht(function(e,n){return t.toBlob().then(function(t){te(r,Jt(t),e,n)})})}};function ne(t,e){for(var n=0,r=t.length;n<r;n++){var o=t[n];if(e(o,n))return p.some(o)}return p.none()}var re,oe={getImageSize:function(t){var e,n;function r(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?r(e)&&r(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)},setImageSize:function(t,e){var n,r;e&&(n=t.style.width,r=t.style.height,(n||r)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,r=t.height,(n||r)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))},getNaturalImageSize:function(t){return{w:t.naturalWidth,h:t.naturalHeight}}},o=(re="function",function(t){return function(t){if(null===t)return"null";var e=typeof t;return"object"==e&&(Array.prototype.isPrototypeOf(t)||t.constructor&&"Array"===t.constructor.name)?"array":"object"==e&&(String.prototype.isPrototypeOf(t)||t.constructor&&"String"===t.constructor.name)?"string":e}(t)===re});function ie(t){return null!=t}function ae(e){return"ImageProxy HTTP error: "+ne(me,function(t){return e===t.code}).fold(i("Unknown ImageProxy error"),function(t){return t.message})}function ce(t){return t=ae(t),Ht.reject(t)}function ue(e){return ne(ge,function(t){return t.type===e}).fold(i("Unknown service error"),function(t){return t.message})}function le(t,e){return de(e).then(function(t){t=function(t){t=pe(t),t=fe(t,["error","type"]);return"ImageProxy Service error: "+(t?ue(t):"Invalid JSON in service error message")}(t);return Ht.reject(t)})}function se(t,e){var n,r={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return he((n=e,t=-1===(e=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(e)||!n?e:e+t+"apiKey="+encodeURIComponent(n)),r,!1).then(function(t){return t.status<200||300<=t.status?ve(t.status,t.blob):Ht.resolve(t.blob)})}Array.prototype.slice,o(Array.from)&&Array.from;var fe=function(t,e){t=e.reduce(function(t,e){return ie(t)?t[e]:void 0},t);return ie(t)?t:null},de=function(n){return new Ht(function(e){var t=new(Lt("FileReader"));t.onload=function(t){t=t.target;e(t.result)},t.readAsText(n)})},he=function(e,r,o){return new Ht(function(t){var n=new(Lt("XMLHttpRequest"));n.onreadystatechange=function(){4===n.readyState&&t({status:n.status,blob:this.response})},n.open("GET",e,!0),n.withCredentials=o,J.each(r,function(t,e){n.setRequestHeader(e,t)}),n.responseType="blob",n.send()})},pe=function(t){var e;try{e=JSON.parse(t)}catch(t){}return e},me=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],ge=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],ve=function(t,e){return 400===(n=t)||403===n||500===n?le(0,e):ce(t);var n},ye=ce;function we(t,e){t.notificationManager.open({text:e,type:"error"})}function be(t){return t.selection.getNode()}function xe(t,e){var n,r,o=e.src;return Ae(t,e)?Te(e.src,null,(n=t,r=e,-1!==J.inArray(n.getParam("imagetools_credentials_hosts",[],"string[]"),new Pt(r.src).host))):Ce(t,e)?H(e):(o=t.getParam("imagetools_proxy"),o+=(-1===o.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),t=(t=t).getParam("api_key",t.getParam("imagetools_api_key","","string"),"string"),Te(o,t,!1))}function ke(t){var e=t.editorUpload.blobCache.getByUri(be(t).src);return e?Ht.resolve(e.blob()):xe(t,be(t))}function Re(t){clearTimeout(t.get())}function Ie(a,c,u,l,s){return c.toBlob().then(function(t){var e,n,r=a.editorUpload.blobCache,o=be(a),i=o.src;return a.getParam("images_reuse_filename",!1,"boolean")&&(e=(n=r.getByUri(i))?(i=n.uri(),n.name()):function(t,e){e=e.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return e?t.dom.encode(e[1]):null}(a,i)),n=r.create({id:"imagetools"+Ue++,blob:t,base64:c.toBase64(),uri:i,name:e}),r.add(n),a.undoManager.transact(function(){a.$(o).on("load",function t(){var e,n,r;a.$(o).off("load",t),a.nodeChanged(),u?a.editorUpload.uploadImagesAuto():(Re(l),e=a,n=l,r=St.setEditorTimeout(e,function(){e.editorUpload.uploadImagesAuto()},e.getParam("images_upload_timeout",3e4,"number")),n.set(r))}),s&&a.$(o).attr({width:s.w,height:s.h}),a.$(o).attr({src:n.blobUri()}).removeAttr("data-mce-src")}),n})}function Me(e,n,t,r){return function(){return e._scanForImages().then(a(ke,e)).then(jt).then(t).then(function(t){return Ie(e,t,!1,n,r)},function(t){we(e,t)})}}var Te=function(t,e,n){return e?se(t,e):he(t,{},n).then(function(t){return t.status<200||300<=t.status?ye(t.status):Ht.resolve(t.blob)})},Ue=0,Ce=function(t,e){e=e.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new Pt(e).host===t.documentBaseURI.host},Ae=function(t,e){return-1!==J.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new Pt(e.src).host)},Ee=function(e,n,r){return function(){var t=oe.getImageSize(be(e)),t=t?{w:t.h,h:t.w}:null;return Me(e,n,function(t){return _t(t,r)},t)()}},Oe=function(t,e,n){return function(){return Me(t,e,function(t){return At(t,n)})()}},_e=function(e,r){return function(){function n(r){return new Ht(function(n){S(r).then(function(t){var e=oe.getNaturalImageSize(t);i.w===e.w&&i.h===e.h||oe.getImageSize(o)&&oe.setImageSize(o,e),Bt.revokeObjectURL(t.src),n(r)})})}var o=be(e),i=oe.getNaturalImageSize(o);ke(e).then(jt).then(a(function(e,t){return ee.edit(e,t).then(n).then(jt).then(function(t){return Ie(e,t,!0,r)},function(){})},e),function(t){we(e,t)})}},je=function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(Ce(t,e)||Ae(t,e)||t.settings.imagetools_proxy)},ze=Re,Le=function(n,t){J.each({mceImageRotateLeft:Ee(n,t,-90),mceImageRotateRight:Ee(n,t,90),mceImageFlipVertical:Oe(n,t,"v"),mceImageFlipHorizontal:Oe(n,t,"h"),mceEditImage:_e(n,t)},function(t,e){n.addCommand(e,t)})},Be=function(n,r,o){n.on("NodeChange",function(t){var e=o.get();e&&e.src!==t.element.src&&(ze(r),n.editorUpload.uploadImagesAuto(),o.set(null)),je(n,t.element)&&o.set(t.element)})},Se=function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})},He=function(t){t.addContextToolbar(a(je,t),t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions"))};e.add("imagetools",function(t){var e=r(0),n=r(null);Le(t,e),Se(t),He(t),Be(t,e,n)})}(window);